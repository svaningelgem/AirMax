<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, width=device-width" />
		<script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"    type="text/javascript" charset="utf-8"></script>
		<script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>

		<script src="https://code.jquery.com/jquery-1.11.3.js"></script>
	</head>

	<body>
		<div style="width: 640px; height: 480px" id="mapContainer" />

		<script>
			var REFRESH_TIME = 10000; // Refreshes the data every x ms
			var PARAMETER    = 'pm25';
			
			// Initialize the platform object:
			var platform = new H.service.Platform({
				'apikey': 'TJ7rJrCuPsNUbUB_rlM_xDZoI74lqV1GJO3JgHFShfQ'
			});

			// Obtain the default map types from the platform object
			var maptypes = platform.createDefaultLayers();

			// Instantiate (and display) a map object:
			var map = new H.Map(
				document.getElementById('mapContainer'),
				maptypes.vector.normal.map,
				{
				  zoom: 7.75, // Best zoom for this container
				  center: { lng: 4.425585, lat: 50.517215 } // Center of Belgium
				}
			);

			var all_circles = [];

			function fetch_and_display() {
				$.get("http://127.0.0.1:5000/q?parameter="+PARAMETER, function(data) {
					// 1. loop over the current elements and remove the ones that have changed (or are not present anymore in the data)
					map.getObjects().forEach(function(el, idx) {
						d = el.getData();

						// Find this particular element in the data array:
						for ( i = 0; i < data.length; i++ ) {
							if ( d.lng == data[i].lng && d.lat == data[i].lat ) {
								if ( d.val == data[i].val ) { // Same data -- remove it so we don't process it again
									data.splice(i, 1);
								}
								else { // Different data -- remove the circle
									map.removeObject(el);
								}
								break;
							}
						}
					});

					// 2. add the rest
					data.forEach(function(el, idx) {
						var circle = new H.map.Circle(
							{lat: el.lat, lng: el.lng},
							8000,
							{ style:
								{
									fillColor: 'rgba(255, 0, 0, 0.5)'
									, strokeColor: 'rgba(255, 0, 0, 1)'
								}
							}
						);
						circle.setData(el);
						map.addObject(circle);
					});
				});
			}

			function cron() {
				fetch_and_display();
				setTimeout(function() { cron(); }, REFRESH_TIME);
			}

			cron();
		</script>
	</body>
</html>